<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="https://seicing.com/res/favicon.ico" />
    <script language="javascript" src="https://seicing.com/js/defaultall.js"></script>
    <link href="https://seicing.com/css/style.css" rel="stylesheet" type="text/css" media="screen" /> 
<title>肥猫的秘密基地</title>
<link href="https://seicing.com/css/lavibana.css" rel="stylesheet" type="text/css" media="screen" />
<script type="text/javascript" src="https://seicing.com/js/jquery-3.1.1.min.js"></script>
<script type="text/javascript" src="https://seicing.com/js/vue3.js"></script>
<style>
    .rows2 {
        display: flex;
        align-items: flex-start;
    }

    .left {
        width: 150px;
    }

    .right {
        margin-left: 10px;
    }



    body {
        font-family: sans-serif;
    }

    .stage {
        position: relative;
        width: 150px;
        height: 225px;
        border: 1px solid #aaa;
        margin-bottom: 10px;
        background-color: #f0f0f0;
    }

    .layer {
        position: absolute;
        top: 0;
        left: 0;
    }

    img {
        width: 150px;
        display: block;
    }

    button {
        margin: 2px;
        cursor: pointer;
        padding: 5px 10px;
    }

    button.active {
        background: #c0392b;
        color: #fff;
        border: 1px solid #a93226;
    }


    #dialogueBox {
        left: 170px;
        top: 20px;
        width: 220px;
        min-height: 60px;
        padding: 8px 10px;
        border: 1px solid #555;
        background: #fff;
        font-size: 14px;
        line-height: 1.4;
        display: none;
        margin-left: 5px;
        margin-top: 150px;
        text-align: left;
    }

    #dialogueText {
        word-break: break-all;
    }

    button.disabled {
        opacity: 0.4;
        cursor: not-allowed;
        pointer-events: none;
    }
</style>
</head>

<body id='scroll-2'>
    <button id="sidebar-toggle-button">☰</button>
    <button id="back-to-top-button">▲</button>
    <div id="sidebar-overlay"></div>
    <div id="wrapper" style="width:1280px ; margin:auto">
        <div id="wrapper2">
            <div id="header" class="container">
                <div id="logo">
                    <H1>
                        <span style="color: #FFFFFF">肥猫的秘密基地</span>
                    </H1>
                </div>
            </div>
            <div id="page">
                <div id="content">
                    <div class="post">
                        <h2 class="title"><a href="#"><b></b></a></h2>
                        <div style="clear: both;">&nbsp;</div>
                        <div class="entry"><a href="https://seicing.com/html/largelv/chars.html" target="_blank">复制内部id(英文)</a>到输入框后加载切换角色<br>

<input id="charId" value="YoEmpireFlower">
<button onclick="loadChar()">加载</button>
<span id="loadStatus" style="font-size:12px; color:blue; margin-left:10px;"></span>

<div class="rows2">
    <div class="stage left">
        <div class="layer" style="z-index:2"><img id="base"></div>
        <div class="layer" style="z-index:4"><img id="eye"></div>
        <div class="layer" style="z-index:6"><img id="brow"></div>
        <div class="layer" style="z-index:7"><img id="mouth"></div>

        <div class="layer" style="z-index:40"><img id="attach"></div>
        <div class="layer" style="z-index:41"><img id="special"></div>
        <div class="layer" style="z-index:39"><img id="sweat"></div>
        <div class="layer" style="z-index:38"><img id="red_face"></div>
    </div>
    <div class="right" id="dialogueBox">
        <div id="dialogueText"></div>
    </div>
</div>


<!-- 状态控制区 -->
<div style="margin-bottom: 10px;">
    <button id="talkBtn" onclick="toggleTalk(this)">说话(talk)</button>
    <!-- 新增闭眼按钮 -->
    <button id="closeEyeBtn" onclick="toggleCloseEyes(this)">闭眼(CE)</button>
</div>
<div style="margin-bottom:10px;">
    <button onclick="startDialogue('嗯嗯嗯……测试一下对话系统，如何，正常吗？')">
        测试用对话1
    </button>
    <button onclick="startDialogue('要说更长的对话吗？那就……拉比巴那~拉比巴那~拉比巴那~拉比巴那~拉比巴那~拉比巴那~拉比巴那~')">
        测试用对话2
    </button>
    <button onclick="startDialogue('今天过得如何？')">
        测试用对话3
    </button>
</div>


<h4>说话模式</h4>
<!-- 默认改为动画序列 -->
<button class="talkModeBtn active" onclick="setTalkMode(1,this)">现有帧序列动画</button>
<button class="talkModeBtn" onclick="setTalkMode(2,this)">专用帧序列动画</button>


<h4>配件</h4>
<!-- 传入 this 以便控制按钮样式 -->
<button class="accBtn" onclick="toggleAcc('attach', this)">attach(AT)</button>
<button class="accBtn" onclick="toggleAcc('special', this)">special(SP)</button>
<button class="accBtn" onclick="toggleAcc('sweat', this)">sweat(SW)</button>
<button class="accBtn" onclick="toggleAcc('red_face', this)">red_face(RF)</button>

<hr>
<div id="faces"></div>
</div>
                    </div>
                </div>
                <div id="sidebar" style="position:relative; left:-20px">
                    <a href="https://seicing.com/html/index.html"><b>回到首页</b></a>
                </div>
                <div style="clear: both;">&nbsp;</div>
                <div style="float:right; width:850px; text-align:right; border-top: 1px dashed #CACACA;"><br>
                    
<a href="https://seicing.com/html/index.html"><b>回到首页</b></a>
                </div>
                <div style="clear: both;">&nbsp;</div>

            </div>

        </div>
    </div>
</body>

<script>
    /* ========= 表情表 ========= */
    const faces = {
        smile: ["eye_default1", "eye_default2", "eye_default3", "brow_default", "mouth_smile"],
        serene: ["eye_default1", "eye_default2", "eye_default3", "brow_default", "mouth_serene"],
        sad: ["eye_default1", "eye_default2", "eye_default3", "brow_sad", "mouth_sad"],
        depress: ["eye_depress1", "eye_default2", "eye_default3", "brow_default", "mouth_depress"],
        sinister: ["eye_depress1", "eye_default2", "eye_default3", "brow_default", "mouth_sinister"],
        surprise: ["eye_surprise1", "eye_default2", "eye_default3", "brow_default", "mouth_surprise"],
        side: ["eye_side1", "eye_side2", "eye_default3", "brow_default", "mouth_serene"],
        shy: ["eye_side1", "eye_side2", "eye_default3", "brow_default", "mouth_smile"],
        happy: ["eye_default1", "eye_default2", "eye_default3", "brow_default", "mouth_happy"],
        bitter: ["eye_default1", "eye_default2", "eye_default3", "brow_sad", "mouth_happy"],
        wry: ["eye_default1", "eye_default2", "eye_default3", "brow_sad", "mouth_smile"],
        cry: ["eye_cry1", "eye_cry2", "eye_cry3", "brow_sad", "mouth_cry"],
        bawl: ["eye_cry1", "eye_cry2", "eye_cry3", "brow_sad", "mouth_angry"],
        crysurprise: ["eye_cry1", "eye_cry2", "eye_cry3", "brow_sad", "mouth_surprise"],
        cryhappy: ["eye_cry1", "eye_cry2", "eye_cry3", "brow_sad", "mouth_happy"],
        fear: ["eye_default1", "eye_default2", "eye_default3", "brow_sad", "mouth_panic"],
        endure: ["eye_depress1", "eye_default2", "eye_default3", "brow_sad", "mouth_endure"],
        uncomfortable: ["eye_default1", "eye_default2", "eye_default3", "brow_sad", "mouth_cry"],
        angry: ["eye_surprise1", "eye_default2", "eye_default3", "brow_angry", "mouth_angry"],
        excited: ["eye_surprise1", "eye_default2", "eye_default3", "brow_angry", "mouth_excited"],
        extra1: ["eye_extra1", "eye_extra1", "eye_extra1", "eye_extra1", "mouth_extra1"],
        extra2: ["eye_extra2", "eye_extra2", "eye_extra2", "eye_extra2", "mouth_extra2"],
        extra3: ["eye_extra3", "eye_extra3", "eye_extra3", "eye_extra3", "mouth_extra3"],
        extra4: ["eye_extra4", "eye_extra4", "eye_extra4", "eye_extra4", "mouth_extra4"],
        extra5: ["eye_extra5", "eye_extra5", "eye_extra5", "eye_extra5", "mouth_extra5"]
    };

    /* ========= 新增：缺失资源记录 ========= */
    const missingImages = new Set();

    /* ========= 状态 ========= */
    let charPath = "";
    let currentFace = faces.smile;
    let blinkTimer = null;
    let talkTimer = null;
    let talking = false;
    let talkMode = 1;
    let isClosedEyes = false;

    /* ========= DOM ========= */
    const eye = document.getElementById("eye");
    const brow = document.getElementById("brow");
    const mouth = document.getElementById("mouth");
    const base = document.getElementById("base");

    const acc = {
        attach: document.getElementById("attach"),
        special: document.getElementById("special"),
        sweat: document.getElementById("sweat"),
        red_face: document.getElementById("red_face")
    };

    /* ========= 说话帧 ========= */
    const talkRandomFrames = [
        "mouth_serene",
        "mouth_endure",
        "mouth_surprise",
        "mouth_endure",
    ];

    const talkSeqFrames = [
        "mouth_ani1",
        "mouth_ani2",
        "mouth_ani3",
        "mouth_ani2"
    ];

    function src(name) {
        return charPath + name + ".png";
    }

    /* ========= 预加载（修改版） ========= */
    function preloadImages(callback) {
        missingImages.clear();

        const allImages = new Set();
        allImages.add("base");

        Object.values(faces).forEach(arr => arr.forEach(n => allImages.add(n)));
        talkRandomFrames.forEach(n => allImages.add(n));
        talkSeqFrames.forEach(n => allImages.add(n));
        Object.keys(acc).forEach(n => allImages.add(n));

        const total = allImages.size;
        let loaded = 0;
        const statusEl = document.getElementById("loadStatus");

        function done() {
            if (callback) callback();
        }

        allImages.forEach(name => {
            const img = new Image();
            img.onload = () => {
                loaded++;
                if (loaded >= total) done();
            };
            img.onerror = () => {
                missingImages.add(name);   // 👈 核心
                loaded++;
                if (loaded >= total) done();
            };
            img.src = src(name);
        });
    }

    /* ========= 新增：根据缺失资源禁用按钮 ========= */
    function applyMissingResources() {

        // 说话模式
        if (talkRandomFrames.some(n => missingImages.has(n))) {
            document.querySelectorAll(".talkModeBtn")[0]?.classList.add("disabled");
        }
        if (talkSeqFrames.some(n => missingImages.has(n))) {
            document.querySelectorAll(".talkModeBtn")[1]?.classList.add("disabled");
        }

        // 配件
        Object.keys(acc).forEach(name => {
            if (missingImages.has(name)) {
                document
                    .querySelector(`button[onclick*="'${name}'"]`)
                    ?.classList.add("disabled");
            }
        });

        // 表情
        Object.keys(faces).forEach(face => {
            if (faces[face].some(n => missingImages.has(n))) {
                document.getElementById("face_" + face)
                    ?.classList.add("disabled");
            }
        });

        // 调试打印（可留可删）
        if (missingImages.size > 0) {
            console.group("❌ 缺失资源");
            console.table([...missingImages]);
            console.groupEnd();
        }
    }

    /* ========= 加载 ========= */
    function loadChar() {
        const id = document.getElementById("charId").value;
        charPath = "https://data.seicing.com/seicingdepot/fatcatpool/essay/chara/" + id + "/";

        base.src = src("base");

        Object.values(acc).forEach(x => {
            x.style.display = "none";
            x.src = "";
        });

        document.querySelectorAll("button").forEach(b => b.classList.remove("disabled"));

        setFace("smile");

        preloadImages(() => {
            startBlink();
            applyMissingResources(); // 👈 关键调用
        });
    }

    /* ========= 表情 / 眨眼 / 说话 / 对话 ========= */
    /* （以下逻辑你原样保留，我未改动） */

    // ……【此处省略：你后面的逻辑完全不需要改】……

    loadChar();
</script>

</html>