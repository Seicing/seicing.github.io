<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="https://seicing.com/res/favicon.ico" />
    <script language="javascript" src="https://seicing.com/js/defaultall.js"></script>
    <link href="https://seicing.com/css/style.css" rel="stylesheet" type="text/css" media="screen" /> 
<title>帝国时代文明地图</title>
<link href="https://seicing.com/css/table.css" rel="stylesheet" type="text/css" media="screen" />
<link href="https://seicing.com/css/link.css" rel="stylesheet" type="text/css" media="screen" />
<link href="https://seicing.com/css/leaflet.css" rel="stylesheet" type="text/css" media="screen" />
<script type="text/javascript" src="https://seicing.com/js/jquery-3.1.1.min.js"> </script>
<script type="text/javascript" src="https://seicing.com/js/leaflet.js"> </script>
<script type="text/javascript">
        $(document).ready(function () {
                $('#sidebar').load('https://seicing.com/js/list/AoeOfEmpires.html');
        })
</script>
<style>
        body,
        html {
                margin: 0;
                height: 100%;
                overflow: hidden;
        }

        #map {
                width: 100%;
                height: 100%;
        }

        /* 坐标显示面板 */
        #coordBox {
                position: absolute;
                top: 10px;
                right: 10px;
                background: rgba(0, 0, 0, 0.6);
                padding: 8px 12px;
                color: #fff;
                border-radius: 6px;
                font-family: monospace;
                z-index: 9999;
        }

        #content,
        .post,
        .entry {
                height: 100%;
                position: relative;
        }

        #map {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
        }
</style>
</head>

<body id='scroll-2'>
    <button id="sidebar-toggle-button">☰</button>
    <button id="back-to-top-button">▲</button>
    <div id="sidebar-overlay"></div>
    <div id="wrapper" style="width:1280px ; margin:auto">
        <div id="wrapper2">
            <div id="header" class="container">
                <div id="logo">
                    <H1>
                        <span style="color: #FFFFFF">肥猫的秘密基地</span>
                    </H1>
                </div>
            </div>
            <div id="page">
                <div id="content">
                    <div class="post">
                        <h2 class="title"><a href="#"><b></b></a></h2>
                        <div style="clear: both;">&nbsp;</div>
                        <div class="entry"><div id="lavipage" page="98"></div>

<div id="map"></div>
<div id="coordBox">X: -, Y: -</div>
</div>
                    </div>
                </div>
                <div id="sidebar" style="position:relative; left:-20px">
                    
                </div>
                <div style="clear: both;">&nbsp;</div>
                <div style="float:right; width:850px; text-align:right; border-top: 1px dashed #CACACA;"><br>
                    
<a href="https://seicing.com/html/index.html"><b>回到首页</b></a>
                </div>
                <div style="clear: both;">&nbsp;</div>

            </div>

        </div>
    </div>
</body>

<script>
        // ============================
        // 地图尺寸（像素）
        // ============================
        const IMG_W = 4650;
        const IMG_H = 2616;
        const bounds = [[0, 0], [IMG_H, IMG_W]];

        // ============================
        // 初始化地图（先给临时中心防止 Leaflet 报错）
        // ============================
        var map = L.map('map', {
                crs: L.CRS.Simple,
                minZoom: -3,
                maxZoom: 3,
                zoomSnap: 0.1,
                attributionControl: false
        });

        // 关键：给一个临时 view，避免“Set map center and zoom first”错误
        map.setView([0, 0], 0, { animate: false });

        // ============================
        // 加载底图
        // ============================
        const overlay = L.imageOverlay('https://data.seicing.com/seicingdepot/fatcatpool/essay/补充/纯粹地图.jpg', bounds).addTo(map);

        overlay.once("load", () => {

                // 设置真实视野
                map.fitBounds(bounds, { animate: false });

                // 手机端必须强制刷新
                setTimeout(() => {
                        map.invalidateSize(true);

                        // 再触发一次 zoom，使手机不出现“需要点+/- 才正常”
                        map.setZoom(map.getZoom(), { animate: false });

                }, 150);
        });

        // ============================
        // 坐标拾取（红点）
        // ============================
        var tempMarker = null;

        map.on('click', function (e) {
                let x = e.latlng.lng;
                let y = e.latlng.lat;

                document.getElementById("coordBox").innerText =
                        `X: ${Math.round(x)} ,  Y: ${Math.round(y)}`;

                if (tempMarker) map.removeLayer(tempMarker);

                tempMarker = L.circleMarker([y, x], {
                        radius: 5,
                        color: "red",
                        fillColor: "red",
                        fillOpacity: 1
                }).addTo(map);

                map.panTo([y, x]);
        });

        // ============================
        // 图标缩放系统
        // ============================
        function iconScale(zoom) {
                return 1 + zoom * 0.25;
        }

        let currentScale = iconScale(map.getZoom());
        const dynamicMarkers = [];

        map.on("zoom", () => {
                currentScale = iconScale(map.getZoom());

                dynamicMarkers.forEach(obj => {
                        let w = obj.baseWidth * currentScale;
                        let h = obj.baseHeight * currentScale;

                        obj.marker.setIcon(
                                L.icon({
                                        iconUrl: obj.data.icon,
                                        iconSize: [w, h],
                                        iconAnchor: [w / 2, h]
                                })
                        );
                });
        });

        // ============================
        // 工具：获取原始宽高 → 用于维持比例
        // ============================
        function loadImageSize(url) {
                return new Promise(res => {
                        const img = new Image();
                        img.onload = () => res({ w: img.width, h: img.height });
                        img.src = url;
                });
        }

        // ============================
        // 加载 locations.json
        // ============================
        fetch("https://seicing.com/js/locations.json")
                .then(res => res.json())
                .then(async list => {

                        for (const p of list) {

                                const baseWidth = (Array.isArray(p.size) ? p.size[0] : p.size) || 36;

                                // 读取图标真实比例
                                const natural = await loadImageSize(p.icon);
                                const ratio = natural.h / natural.w;
                                const baseHeight = baseWidth * ratio;

                                const w = baseWidth * currentScale;
                                const h = baseHeight * currentScale;

                                let icon = L.icon({
                                        iconUrl: p.icon,
                                        iconSize: [w, h],
                                        iconAnchor: [w / 2, h]
                                });

                                let mk = L.marker([p.y, p.x], { icon })
                                        .addTo(map)
                                        .bindTooltip(p.name || "无名地点", {
                                                direction: "top",
                                                offset: [0, -10],
                                                opacity: 0.85
                                        })
                                        .on("click", () => { if (p.url) location.href = p.url; });

                                dynamicMarkers.push({
                                        marker: mk,
                                        data: p,
                                        baseWidth,
                                        baseHeight
                                });
                        }
                });
</script>

</html>