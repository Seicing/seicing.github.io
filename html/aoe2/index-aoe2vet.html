<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="https://seicing.com/res/favicon.ico" />
    <script language="javascript" src="https://seicing.com/js/defaultall.js"></script>
    <link href="https://seicing.com/css/style.css" rel="stylesheet" type="text/css" media="screen" /> 
<title>帝国时代II 加成表</title>
<link href="https://seicing.com/css/table.css" rel="stylesheet" type="text/css" media="screen" />
<link href="https://seicing.com/css/link.css" rel="stylesheet" type="text/css" media="screen" />
<script type="text/javascript" src="https://seicing.com/js/jquery-3.1.1.min.js"> </script>
<script type="text/javascript">
    $(document).ready(function () {
        $('#sidebar').load('https://seicing.com/js/list/AoeOfEmpires.html');
    })
</script>
<script>
    fetch("https://seicing.com/js/list/AOE2DIC3.html")
        .then(r => r.text())
        .then(html => {
            document.getElementById("civList").innerHTML = html;
        });
</script>
<script src="https://seicing.com/js/techaoe2.js"></script>

<script>
    /* =====================================================
       文明列表解析（唯一文明来源）
    ===================================================== */
    function getCivList() {
        const civs = [];
        document
            .querySelectorAll('#civList img[id$="2"]')
            .forEach(img => {
                civs.push({
                    key: img.id.replace(/2$/, ""),
                    icon: img.getAttribute("src"),
                    title: img.getAttribute("title") || ""
                });
            });
        return civs;
    }

    /* =====================================================
       【核心】从 techaoe2.js 真实提取禁用科技
    ===================================================== */
    const DISABLED_TECH_MAP = {};
    let CURRENT_TECH_CONTEXT = null;

    /* 调试用：最近一次成功读取的通用科技 */
    let LAST_READ_TECHS = [];

    /* 主控科技（main:1，只认第一个） */
    let MAIN_TECH = null;

    (function patchGetElementById() {
        const original = document.getElementById;
        document.getElementById = function (id) {
            if (CURRENT_TECH_CONTEXT) {
                const m = id.match(/^([A-Za-z]+)2$/);
                if (m) {
                    const civ = m[1];
                    if (!DISABLED_TECH_MAP[CURRENT_TECH_CONTEXT]) {
                        DISABLED_TECH_MAP[CURRENT_TECH_CONTEXT] = {};
                    }
                    DISABLED_TECH_MAP[CURRENT_TECH_CONTEXT][civ] = true;
                }
            }
            return original.call(document, id);
        };
    })();

    /* =====================================================
       执行 techaoe2.js 科技函数
       ✔ 仅统计通用科技
       ✔ 仅统计 techaoe2 中真实存在的函数
       ✔ 提取 main 科技
    ===================================================== */
    function collectDisabledTechFromAOE2(form) {
        const techNames = new Set();
        const readTechs = [];

        MAIN_TECH = null;

        form.common?.forEach(t => {
            techNames.add(t.tech);

            // 只认第一个 main
            if (t.main === 1 && !MAIN_TECH) {
                MAIN_TECH = t;
                console.log("本次 main 科技:", MAIN_TECH);
            }
        });

        techNames.forEach(tech => {
            if (typeof window[tech] !== "function") return;

            CURRENT_TECH_CONTEXT = tech;
            try {
                window[tech]();
                readTechs.push(tech);
            } catch (e) { }
            CURRENT_TECH_CONTEXT = null;
        });

        LAST_READ_TECHS = readTechs.slice();

        console.group(
            `[AOE2] techaoe2 成功返回的通用科技（${form.tableId}）`
        );
        readTechs.forEach(t => console.log(t));
        console.groupEnd();

        return readTechs;
    }

    /* =====================================================
       科技图标解析
    ===================================================== */
    function resolveTechIcon(item, civ) {
        if (item.iconByCiv) {
            if (item.iconByCiv[civ]) return item.iconByCiv[civ];
            if (item.iconByCiv.default) return item.iconByCiv.default;
        }
        if (item.icon) return item.icon;
        return `https://data.seicing.com/seicingdepot/3fatcatpool/aoe2/tech/${item.tech}.webp`;
    }

    /* =====================================================
       当前表单缓存
    ===================================================== */
    let CURRENT_FORM = null;

    /* =====================================================
       表格生成（支持 unique.replace + main）
    ===================================================== */
    function generateTable(form) {

        const civs = getCivList();

        /* ===== unique.civ 合法性警告 ===== */
        const validCivs = new Set(civs.map(c => c.key));
        (form.unique || []).forEach(u => {
            if (!validCivs.has(u.civ)) {
                console.warn(
                    `[AOE2][WARN] unique.civ 不存在于文明列表`,
                    {
                        civ: u.civ,
                        tech: u.tech,
                        replace: u.replace || null,
                        table: form.tableId
                    }
                );
            }
        });

        /* ===== 过滤掉 main 科技（不显示） ===== */
        const commonTechs = (form.common || []).filter(
            t => !(MAIN_TECH && t.tech === MAIN_TECH.tech)
        );

        /* ===== unique → common 替换映射 ===== */
        const replaceMapByCiv = {};
        (form.unique || []).forEach(u => {
            if (!u.replace) return;
            if (!replaceMapByCiv[u.civ]) replaceMapByCiv[u.civ] = {};
            replaceMapByCiv[u.civ][u.replace] = u;
        });

        /* ===== 最大独特科技数（排除 replace） ===== */
        const uniqueCountByCiv = {};
        (form.unique || []).forEach(u => {
            if (u.replace) return;
            uniqueCountByCiv[u.civ] = (uniqueCountByCiv[u.civ] || 0) + 1;
        });
        const maxUnique = Math.max(0, ...Object.values(uniqueCountByCiv));

        let html = `<table class="tech-table">`;

        civs.forEach(civObj => {
            const civ = civObj.key;
            let total = 0;

            html += "<tr>";

            /* ===== 文明图标（受 main 控制） ===== */
            const mainBanned =
                MAIN_TECH &&
                DISABLED_TECH_MAP[MAIN_TECH.tech]?.[civ];

            html += `
<td class="civcell ${mainBanned ? 'main-banned' : ''}">
  <img src="${civObj.icon}">
</td>`;

            /* ===== 通用科技 ===== */
            commonTechs.forEach(item => {

                const replaceItem = replaceMapByCiv[civ]?.[item.tech];
                const techItem = replaceItem || item;
                const isUniqueReplace = !!replaceItem;

                const banned = DISABLED_TECH_MAP[item.tech]?.[civ];
                const icon = isUniqueReplace
                    ? replaceItem.icon
                    : resolveTechIcon(item, civ);

                html += `
<td class="tech ${banned ? 'unavailable' : 'available'} ${isUniqueReplace ? 'unique' : ''}">
  <a onmousemove="showPic(event,'${techItem.showId || techItem.tech}');"
     onmouseout="hiddenPic();">
    <img src="${icon}">
    ${banned ? `<img class="cannot" src="https://data.seicing.com/seicingdepot/3fatcatpool/cannot.png">` : ""}
  </a>
</td>`;

                if (!banned) total += techItem.score || 0;
            });

            /* ===== 独特科技（右侧） ===== */
            const uniques = (form.unique || []).filter(u =>
                u.civ === civ && !u.replace
            );

            for (let i = 0; i < maxUnique; i++) {
                const item = uniques[i];
                if (!item) {
                    html += "<td></td>";
                    continue;
                }

                html += `
<td class="tech unique available">
  <a onmousemove="showPic(event,'${item.showId || item.tech}');"
     onmouseout="hiddenPic();">
    <img src="${item.icon}">
  </a>
</td>`;

                total += item.score || 0;
            }

            html += `<td class="score">${total}</td>`;
            html += "</tr>";
        });

        html += "</table>";
        document.getElementById(form.tableId).innerHTML = html;
    }

    /* =====================================================
       加载 JSON 表单
    ===================================================== */
    function loadFormByTableId(tableId) {
        const url = `https://seicing.com/js/listaoe2/${tableId}.json`;

        fetch(url)
            .then(r => {
                if (!r.ok) throw new Error("表单不存在");
                return r.json();
            })
            .then(form => {
                CURRENT_FORM = form;
                collectDisabledTechFromAOE2(form);
                generateTable(form);
            })
            .catch(err => {
                console.error(err);
                document.getElementById(tableId).innerHTML =
                    "<p style='color:red'>表单加载失败</p>";
            });
    }

    /* =====================================================
       切换表格（按钮调用）
    ===================================================== */
    function switchTable(tableId, el) {
        // 移除所有按钮的 active
        document.querySelectorAll('.tech-tab.active')
            .forEach(img => img.classList.remove('active'));

        // 给当前按钮的 img 加 active
        if (el) {
            const img = el.querySelector('.tech-tab');
            if (img) img.classList.add('active');
        }

        const container = document.getElementById("techTableContainer");

        // 隐藏或清空占位文字
        const noTable = document.getElementById("noTable");
        if (noTable) noTable.style.display = "none";

        // 生成表格容器
        container.innerHTML = "";
        const div = document.createElement("div");
        div.id = tableId;
        container.appendChild(div);

        // 加载表单
        loadFormByTableId(tableId);
    }


    /* =====================================================
       页面初始化
    ===================================================== */
    document.addEventListener("DOMContentLoaded", () => {
        fetch("https://seicing.com/js/list/AOE2DIC3.html")
            .then(r => r.text())
            .then(html => {
                document.getElementById("civList").innerHTML = html;

                // 不自动生成表格，原来的第一按钮点击逻辑去掉
                // const firstBtn = document.querySelector('.tech-tab');
                // if (firstBtn) {
                //     switchTable("infantryTable", firstBtn);
                // }
            });
    });
</script>


</head>

<body id='scroll-2'>
    <button id="sidebar-toggle-button">☰</button>
    <button id="back-to-top-button">▲</button>
    <div id="sidebar-overlay"></div>
    <div id="wrapper" style="width:1280px ; margin:auto">
        <div id="wrapper2">
            <div id="header" class="container">
                <div id="logo">
                    <H1>
                        <span style="color: #FFFFFF">肥猫的秘密基地</span>
                    </H1>
                </div>
            </div>
            <div id="page">
                <div id="content">
                    <div class="post">
                        <h2 class="title"><a href="#"><b></b></a></h2>
                        <div style="clear: both;">&nbsp;</div>
                        <div class="entry"><div id="lavipage" page="29"></div>
<div id="civList"></div>

<div style="text-align: center;">

    <a onclick="switchTable('infantryTable', this)">
        <img src="https://data.seicing.com/seicingdepot/3fatcatpool/aoe2/unit/Longswordsman_aoe2DE.webp" width="28px" class="tech-tab">
    </a>
    <a onclick="switchTable('spearmanTable', this)">
        <img src="https://data.seicing.com/seicingdepot/3fatcatpool/aoe2/unit/Aoe2-infantry-2-pikeman.webp" width="28px" class="tech-tab">
    </a>

    <a onclick="switchTable('archerTable', this)">
        <img src="https://data.seicing.com/seicingdepot/3fatcatpool/aoe2/unit/Crossbowman_aoe2DE.webp" width="28px" class="tech-tab">
    </a>
    <a onclick="switchTable('cavalryarcherTable', this)">
        <img src="https://data.seicing.com/seicingdepot/3fatcatpool/aoe2/unit/Cavalryarcher_aoe2DE.webp" width="28px" class="tech-tab">
    </a>
    <a onclick="switchTable('skirmisherTable', this)">
        <img src="https://data.seicing.com/seicingdepot/3fatcatpool/aoe2/unit/Skirmisher_aoe2DE.webp" width="28px" class="tech-tab">
    </a>
    <a onclick="switchTable('handcannonTable', this)">
        <img src="https://data.seicing.com/seicingdepot/3fatcatpool/aoe2/unit/Hand_cannoneer_aoe2DE.webp" width="28px" class="tech-tab">
    </a>

    <a onclick="switchTable('cavalryTable', this)">
        <img src="https://data.seicing.com/seicingdepot/3fatcatpool/aoe2/unit/Lightcavalry_aoe2DE.webp" width="28px" class="tech-tab">
    </a>
    <a onclick="switchTable('knightTable', this)">
        <img src="https://data.seicing.com/seicingdepot/3fatcatpool/aoe2/unit/Knight_aoe2DE.webp" width="28px" class="tech-tab">
    </a>
    <a onclick="switchTable('camelriderTable', this)">
        <img src="https://data.seicing.com/seicingdepot/3fatcatpool/aoe2/unit/Camelrider_aoe2DE.webp" width="28px" class="tech-tab">
    </a>


    <a onclick="switchTable('ramTable', this)">
        <img src="https://data.seicing.com/seicingdepot/3fatcatpool/aoe2/unit/Capped_ram_aoe2DE.webp" width="28px" class="tech-tab">
    </a>
    <a onclick="switchTable('scorpionTable', this)">
        <img src="https://data.seicing.com/seicingdepot/3fatcatpool/aoe2/unit/Scorpion_aoe2DE.webp" width="28px" class="tech-tab">
    </a>
    <a onclick="switchTable('onagerTable', this)">
        <img src="https://data.seicing.com/seicingdepot/3fatcatpool/aoe2/unit/Onager_aoe2DE.webp" width="28px" class="tech-tab">
    </a>
    <a onclick="switchTable('bombardCannonTable', this)">
        <img src="https://data.seicing.com/seicingdepot/3fatcatpool/aoe2/unit/Bombard_cannon_aoe2DE.webp" width="28px" class="tech-tab">
    </a>

    <a onclick="switchTable('trebuchetTable', this)">
        <img src="https://data.seicing.com/seicingdepot/3fatcatpool/aoe2/unit/Trebuchet_aoe2DE.webp" width="28px" class="tech-tab">
    </a>



</div>


<br><br>
<div id="techTableContainer">
    <div id="noTable"></div>
    <b>评分规则</b>
    <ul>
        <li>通用科技1分
            <ul>
                <li>鼓风炉和护腕是重要的“三攻科技”，视为2分</li>
            </ul>
        </li>
        <li>兵种升级科技1分，最高级升级科技2分
            <ul>
                <li>重装骑士升级2分，游侠升级3分(包括萨瓦尔)</li>
                <li>罗马军是整合了双手剑士和冠军剑士升级+文明加成的构成，视为4分</li>
                <li>波兰翼骑兵是翼骑兵+文明加成的构成，视为3分</li>
            </ul>
        </li>
        <li>文明加成1分
            <ul>
                <li>部分强力加成视为2分：立陶宛圣物骑兵加成</li>
                <li>部分不直接作用于战斗或过弱的加成视为0分：凯尔特牵羊和缅甸修道院加成</li>
            </ul>
        </li>
        <li>独特科技加成2分
            <ul>
                <li>部分强力科技被视为3分：攻城(蒙古)、扭绞机(埃塞)</li>
            </ul>
        </li>
    </ul>
    <br>
    <b>特殊处理</b>
    <ul>
        <li>蜀战车、印度攻城象等生物攻城器接受骑兵加成，这部分科技会视为0分(但血统这个直接影响耐久度的科技会依旧+1分)</li>
        <li>掷矛手指环科技不加攻速，仅加命中率，而掷矛手本身命中率很高，因此掷矛手专用指环科技视为0.5分</li>
        <li>牵引抛石机怎么看都是巨型投石机的弱化版，额外-1分</li>
    </ul>
</div></div>
                    </div>
                </div>
                <div id="sidebar" style="position:relative; left:-20px">
                    
                </div>
                <div style="clear: both;">&nbsp;</div>
                <div style="float:right; width:850px; text-align:right; border-top: 1px dashed #CACACA;"><br>
                    
<a href="https://seicing.com/html/index.html"><b>回到首页</b></a>
                </div>
                <div style="clear: both;">&nbsp;</div>

            </div>

        </div>
    </div>
</body>

<style>
    .tech-table {
        table-layout: fixed;
        width: max-content;
    }

    .civcell.main-banned {
        background-color: #f6d6d6 !important;
    }

    .civcell.main-banned img {
        opacity: 0.33;
    }

    #techTableContainer {
        overflow-x: auto;
        overflow-y: visible;
        -webkit-overflow-scrolling: touch;
    }


    .tech-table {
        border-collapse: collapse;
        background: #ffffff;
    }

    .tech-table th,
    .tech-table td {
        border: 1px solid #9a9a9a;
        width: 28px;
        height: 28px;
        padding: 2px;
        text-align: center;
        vertical-align: middle;
    }

    .tech-table td.civcell {
        background: #ffffff;
        width: 28px;
        min-width: 28px;
    }

    .tech-table td.civcell img {
        width: 28px;
    }

    .tech {
        position: relative;
    }

    .tech img {
        width: 28px;
        pointer-events: none;
    }

    .tech.available {
        background-color: #c9f8dc;
    }

    .tech.unavailable {
        background-color: #f6d6d6;
    }

    .tech.unavailable img {
        opacity: 0.33;
    }

    .tech.unavailable img[src$="https://data.seicing.com/seicingdepot/3fatcatpool/cannot.png"] {
        opacity: 1;
    }

    .tech.unavailable img:first-child {
        filter: grayscale(100%) brightness(0.8);
    }

    .tech .cannot {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        opacity: 0.85;
        pointer-events: none;
    }

    .score {
        font-weight: bold;
        color: #ffd700;
        background: #111;
    }

    #civList {
        display: none;
    }

    .tech a {
        position: relative;
        display: block;
        width: 28px;
        height: 28px;
    }

    .tech a>img:first-child {
        width: 100%;
        height: 100%;
        display: block;
    }

    /* =========================
       表单切换按钮（图片）
       <a><img class="tech-tab"></a>
    ========================= */

    /* 图标本体 */
    .tech-tab {
        display: inline-block;
        cursor: pointer;
    }

    /* hover：轻微高亮（可选） */
    .tech-tab:hover {
        filter:
            drop-shadow(0 0 3px rgba(255, 200, 140, 0.6));
    }

    /* active：强外发光 */
    .tech-tab.active {
        filter:
            drop-shadow(0 0 3px rgba(255, 144, 80, 1)) drop-shadow(0 0 5px rgba(255, 179, 80, 1));
    }
</style>

</html>